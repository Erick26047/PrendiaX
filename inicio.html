<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inicio | PrendiaX</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f4f4;
      color: #000;
      position: relative;
      overflow-x: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      z-index: -1;
      pointer-events: none;
      display: none;
    }

    .star {
      position: absolute;
      background: #fff;
      border-radius: 50%;
      animation: twinkle 5s infinite, move 20s linear infinite;
      opacity: 0.8;
    }

    .star:nth-child(odd) {
      width: 2px;
      height: 2px;
    }

    .star:nth-child(even) {
      width: 1px;
      height: 1px;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 0.3; }
    }

    @keyframes move {
      0% { transform: translateY(0) translateX(0); }
      100% { transform: translateY(100vh) translateX(10vw); }
    }

    header {
      background-color: #000;
      color: #fff;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    .logo {
      font-size: 32px;
      font-weight: bold;
      color: #fff;
    }

    .header-icons {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .header-icons input {
      padding: 6px 12px;
      border-radius: 15px;
      border: none;
      outline: none;
      font-size: 16px;
      font-family: Arial, sans-serif;
      font-weight: normal;
      background-color: #fff;
      color: #000;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .header-icons input::placeholder {
      color: #000;
      opacity: 0.7;
    }

    .icon-button {
      background-color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 18px;
      color: #000;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: background-color 0.3s ease, color 0.3s ease;
      position: relative;
    }

    .icon-button:hover {
      background-color: #e0e0e0;
    }

    #theme-toggle {
      background-color: #fff;
      color: #000;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: background-color 0.3s ease, color 0.3s ease;
      border: none;
      z-index: 2;
    }

    #theme-toggle:hover {
      background-color: #e0e0e0;
    }

    .perfil-menu {
      position: relative;
      display: inline-block;
    }

    .menu-desplegable {
      display: none;
      position: absolute;
      right: 0;
      top: 50px;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      min-width: 200px;
      z-index: 1000;
      padding: 8px 0;
      font-family: 'Segoe UI', sans-serif;
      animation: slideDown 0.3s ease-in-out;
      border: 1px solid #e0e0e0;
      transition: background-color 0.3s ease, border-color 0.3s ease, opacity 0.3s ease;
    }

    .menu-desplegable::before {
      content: '';
      position: absolute;
      top: -10px;
      right: 14px;
      border-width: 6px;
      border-style: solid;
      border-color: transparent transparent #ffffff transparent;
      transition: border-color 0.3s ease;
    }

    .menu-desplegable a, .menu-desplegable button {
      color: #333333;
      padding: 12px 16px;
      text-decoration: none;
      display: flex;
      align-items: center;
      font-size: 15px;
      font-weight: 500;
      gap: 12px;
      transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
    }

    .menu-desplegable a:hover, .menu-desplegable button:hover {
      background-color: #e3f2fd;
      color: #1976d2;
      transform: translateX(4px);
    }

    .menu-desplegable a i, .menu-desplegable button i {
      font-size: 16px;
      color: #555555;
      transition: color 0.2s ease;
    }

    .menu-desplegable a:hover i, .menu-desplegable button:hover i {
      color: #1976d2;
    }

    .menu-desplegable a:not(:last-child), .menu-desplegable button:not(:last-child) {
      border-bottom: 1px solid #e0e0e0;
    }

    .logout-form {
      margin: 0;
      padding: 0;
      display: contents;
    }

    .categorias-menu {
      position: relative;
      display: inline-block;
    }

    .categorias-desplegable {
      display: none;
      position: absolute;
      left: 0;
      top: 40px;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      width: 250px;
      z-index: 1000;
      padding: 8px 0;
      font-family: 'Segoe UI', sans-serif;
      animation: slideDown 0.3s ease-in-out;
      border: 1px solid #e0e0e0;
      transition: background-color 0.3s ease, border-color 0.3s ease, opacity 0.3s ease;
    }

    .categorias-desplegable::before {
      content: '';
      position: absolute;
      top: -10px;
      left: 14px;
      border-width: 6px;
      border-style: solid;
      border-color: transparent transparent #ffffff transparent;
      transition: border-color 0.3s ease;
    }

    .categorias-desplegable ul {
      list-style: none;
      margin: 0;
      padding: 0;
      max-height: 200px;
      overflow-y: auto;
    }

    .categorias-desplegable li {
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #333333;
      transition: background-color 0.2s ease, color 0.2s ease;
      cursor: pointer;
    }

    .categorias-desplegable li:hover {
      background-color: #e3f2fd;
      color: #1976d2;
    }

    .categorias-desplegable li input[type="checkbox"] {
      margin: 0;
      cursor: pointer;
    }

    .categorias-desplegable li label {
      cursor: pointer;
      flex: 1;
    }

    #otra-categoria {
      padding: 10px 16px;
      display: none;
    }

    #otra-categoria input {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      background-color: #fff;
      color: #000;
      box-sizing: border-box;
      transition: border-color 0.3s ease, background-color 0.3s ease;
    }

    #otra-categoria input:focus {
      border-color: #000;
      outline: none;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    .publicar {
      background-color: #fafafa;
      padding: 20px 30px;
      border-radius: 10px;
      margin-bottom: 30px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    .content-input {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: Arial, sans-serif;
      font-size: 16px;
      font-weight: normal;
      line-height: 1.5;
      box-sizing: border-box;
      text-align: left;
      max-width: 100%;
      background-color: #fff;
      color: #000;
      transition: background-color 0.3s ease, color 0.3s ease;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .content-input:empty:before {
      content: attr(data-placeholder);
      color: #999;
      pointer-events: none;
      display: block;
    }

    .content-input:focus {
      outline: none;
      border-color: #000;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .preview-area {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .publicar button[type="submit"] {
      margin-top: 10px;
      padding: 10px 20px;
      border: none;
      background-color: #000;
      color: #fff;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .feed {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .post {
      background-color: #fafafa;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      position: relative;
    }

    .post-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .post-profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ccc;
    }

    .post-user-info {
      display: flex;
      flex-direction: column;
    }

    .post-user-info .company-name {
      font-size: 16px;
      font-weight: bold;
      color: #000;
      margin: 0;
      transition: color 0.3s ease;
    }

    .post-content {
      margin-bottom: 10px;
    }

    .post-content p {
      margin: 0 0 10px;
      font-size: 16px;
      color: #000;
      line-height: 1.5;
      transition: color 0.3s ease;
    }

    .post-media {
      margin-top: 10px;
    }

    .post-media img, .post-media video {
      max-width: 100%;
      border-radius: 8px;
      display: block;
    }

    .post-meta p {
      margin: 10px 0 0;
      font-size: 14px;
      color: #666;
      transition: color 0.3s ease;
    }

    .post-meta p:last-child {
      font-size: 12px;
      color: #999;
    }

    .delete-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #f44336;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 5px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
    }

    .delete-button:hover {
      background-color: #d32f2f;
    }

    .delete-button i {
      margin: 0;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #4caf50;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      animation: slideIn 0.3s ease-in-out;
      transition: box-shadow 0.3s ease;
    }

    .notification.error {
      background-color: #f44336;
    }

    .notification i {
      font-size: 18px;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes slideOut {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100%); }
    }

    .preview-wrapper {
      position: relative;
      display: inline-block;
    }

    .preview-image, .preview-video {
      width: 50px;
      height: 50px;
      border-radius: 4px;
      border: 1px solid #ccc;
      object-fit: cover;
      vertical-align: middle;
      transition: border-color 0.3s ease;
    }

    .remove-preview {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: #f44336;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      font-size: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
    }

    .remove-preview:hover {
      background-color: #d32f2f;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.2s ease-in-out;
    }

    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      text-align: center;
      max-width: 400px;
      width: 90%;
      color: #000;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .modal-content p {
      margin: 0 0 20px;
      font-size: 16px;
    }

    .modal-content button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin: 0 10px;
      transition: background-color 0.3s ease;
    }

    #confirm-btn {
      background: #f44336;
      color: white;
    }

    #confirm-btn:hover {
      background: #d32f2f;
    }

    #cancel-btn {
      background: #ccc;
      color: black;
    }

    #cancel-btn:hover {
      background: #bbb;
    }

    /* Nuevos estilos para el preview de etiquetas */
    .etiquetas-preview {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-left: 10px;
      align-items: center;
    }

    .etiqueta-pill {
      background-color: #e3f2fd;
      color: #1976d2;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .etiqueta-pill .remove-etiqueta {
      background: none;
      border: none;
      color: #1976d2;
      font-size: 12px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .etiqueta-pill .remove-etiqueta:hover {
      color: #d32f2f;
    }

    body.dark-mode {
      background-color: #000;
      color: #fff;
    }

    body.dark-mode .stars {
      display: block;
    }

    body.dark-mode .header-icons input {
      background-color: #000;
      color: #fff;
    }

    body.dark-mode .header-icons input::placeholder {
      color: #fff;
      opacity: 0.7;
    }

    body.dark-mode .icon-button {
      background-color: #000;
      color: #fff;
    }

    body.dark-mode .icon-button:hover {
      background-color: #222;
    }

    body.dark-mode #theme-toggle {
      background-color: #000;
      color: #fff;
    }

    body.dark-mode #theme-toggle:hover {
      background-color: #222;
    }

    body.dark-mode .menu-desplegable {
      background-color: #2a2a2a;
      border: 1px solid #444444;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }

    body.dark-mode .menu-desplegable::before {
      border-color: transparent transparent #2a2a2a transparent;
    }

    body.dark-mode .menu-desplegable a, body.dark-mode .menu-desplegable button {
      color: #e0e0e0;
    }

    body.dark-mode .menu-desplegable a:hover, body.dark-mode .menu-desplegable button:hover {
      background-color: #3a3a3a;
      color: #90caf9;
    }

    body.dark-mode .menu-desplegable a i, body.dark-mode .menu-desplegable button i {
      color: #aaaaaa;
    }

    body.dark-mode .menu-desplegable a:hover i, body.dark-mode .menu-desplegable button:hover i {
      color: #90caf9;
    }

    body.dark-mode .menu-desplegable a:not(:last-child), body.dark-mode .menu-desplegable button:not(:last-child) {
      border-bottom: 1px solid #444444;
    }

    body.dark-mode .categorias-desplegable {
      background-color: #2a2a2a;
      border: 1px solid #444444;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }

    body.dark-mode .categorias-desplegable::before {
      border-color: transparent transparent #2a2a2a transparent;
    }

    body.dark-mode .categorias-desplegable li {
      color: #e0e0e0;
    }

    body.dark-mode .categorias-desplegable li:hover {
      background-color: #3a3a3a;
      color: #90caf9;
    }

    body.dark-mode #otra-categoria input {
      background-color: #222;
      color: #fff;
      border-color: #444;
    }

    body.dark-mode .publicar {
      background-color: #000;
      border: 1px solid #333;
      box-shadow: 0 2px 5px rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .content-input {
      background-color: #fff;
      color: #000;
    }

    body.dark-mode .preview-area {
      background-color: #000;
    }

    body.dark-mode .publicar button {
      background-color: #000;
      color: #fff;
    }

    body.dark-mode .post {
      background-color: #000;
      border: 1px solid #333;
      box-shadow: 0 2px 5px rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .post-user-info .company-name {
      color: #fff;
    }

    body.dark-mode .post-content p {
      color: #fff;
    }

    body.dark-mode .post-meta p {
      color: #bbb;
    }

    body.dark-mode .post-meta p:last-child {
      color: #888;
    }

    body.dark-mode .notification {
      box-shadow: 0 2px 10px rgba(255, 255, 255, 0.2);
    }

    body.dark-mode .preview-image, body.dark-mode .preview-video {
      border-color: #555;
    }

    body.dark-mode .etiquetas-preview .etiqueta-pill {
      background-color: #3a3a3a;
      color: #90caf9;
    }

    body.dark-mode .etiqueta-pill .remove-etiqueta {
      color: #90caf9;
    }

    body.dark-mode .etiqueta-pill .remove-etiqueta:hover {
      color: #d32f2f;
    }

    body.dark-mode .modal-content {
      background: #222;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="stars"></div>

  <header>
    <div class="logo" data-translate="inicio.logo">PrendiaX</div>
    <div class="header-icons">
      <input type="text" placeholder="Buscar en PrendiaX" id="buscador" oninput="search()" data-translate="inicio.search_placeholder" />
      <button class="icon-button" title="Notificaciones">
        <i class="fas fa-bell"></i>
      </button>
      <button class="icon-button" title="Chats" onclick="window.location.href='/chats'">
        <i class="fas fa-comment-dots"></i>
      </button>
      <button id="theme-toggle" title="Cambiar modo" data-translate="inicio.theme_toggle">
        <i class="fas fa-moon"></i> Modo Nocturno
      </button>
      <div class="language-selector">
        <select id="language-switcher">
          <option value="es">ES</option>
          <option value="en">EN</option>
        </select>
      </div>
      <div class="perfil-menu">
        <button class="icon-button" id="perfil-btn" title="Perfil">
          <i class="fas fa-user-circle"></i>
        </button>
        <div class="menu-desplegable" id="menu-perfil">
          <a href="/perfil" data-translate="inicio.profile_link">
            <i class="fas fa-user-tie"></i>
            <span>Perfil</span>
          </a>
          <form action="/logout" method="post" class="logout-form">
            <button type="submit" data-translate="inicio.logout">
              <i class="fas fa-door-open"></i>
              <span>Salir</span>
            </button>
          </form>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="notification" id="notification">
      <i class="fas fa-check-circle"></i>
      <span id="notification-message"></span>
    </div>

    <div class="publicar">
      <form id="form-publicar" action="/publicar" method="post" enctype="multipart/form-data">
        <div id="content-input" contenteditable="true" class="content-input" data-placeholder="{{ 'inicio.post_placeholder' | translate }}"></div>
        <input type="hidden" name="contenido" id="contenido-hidden">
        <div id="preview-area" class="preview-area"></div>
        <div class="action-buttons">
          <button type="button" class="icon-button" title="Agregar imagen" onclick="document.getElementById('imagen').click()">
            <i class="fas fa-image"></i>
          </button>
          <input type="file" id="imagen" name="imagen" accept="image/*" style="display: none" />
          <button type="button" class="icon-button" title="Agregar video" onclick="document.getElementById('video').click()">
            <i class="fas fa-video"></i>
          </button>
          <input type="file" id="video" name="video" accept="video/*" style="display: none" />
          <div class="categorias-menu">
            <button type="button" class="icon-button" id="categorias-toggle" title="Agregar categorías">
              <i class="fas fa-tags"></i>
            </button>
            <div class="etiquetas-preview" id="etiquetas-preview"></div>
            <div class="categorias-desplegable" id="categorias-menu">
              <ul>
                <li>
                  <input type="checkbox" id="cat-1" name="categorias" value="Restaurantes y comida rápida">
                  <label for="cat-1">Restaurantes y comida rápida</label>
                </li>
                <li>
                  <input type="checkbox" id="cat-2" name="categorias" value="Alimentos y bebidas">
                  <label for="cat-2">Alimentos y bebidas</label>
                </li>
                <li>
                  <input type="checkbox" id="cat-3" name="categorias" value="Ropa">
                  <label for="cat-3">Ropa</label>
                </li>
                <li>
                  <input type="checkbox" id="cat-4" name="categorias" value="Artículos religiosos">
                  <label for="cat-4">Artículos religiosos</label>
                </li>
                <li>
                  <input type="checkbox" id="cat-5" name="categorias" value="Tecnología y electrónica">
                  <label for="cat-5">Tecnología y electrónica</label>
                </li>
                <li>
                  <input type="checkbox" id="cat-6" name="categorias" value="Servicios profesionales">
                  <label for="cat-6">Servicios profesionales</label>
                </li>
                <li>
                  <input type="checkbox" id="cat-7" name="categorias" value="Salud y bienestar">
                  <label for="cat-7">Salud y bienestar</label>
                </li>
                <li>
                  <input type="checkbox" id="cat-8" name="categorias" value="Créditos y servicios financieros">
                  <label for="cat-8">Créditos y servicios financieros</label>
                </li>
                <li>
                  <input type="checkbox" id="cat-9" name="categorias" value="Bienes raíces">
                  <label for="cat-9">Bienes raíces</label>
                </li>
                <li>
                  <input type="checkbox" id="cat-10" name="categorias" value="Entretenimiento y eventos">
                  <label for="cat-10">Entretenimiento y eventos</label>
                </li>
                <li>
                  <input type="checkbox" id="cat-11" name="categorias" value="Educación">
                  <label for="cat-11">Educación</label>
                </li>
                <li>
                  <input type="checkbox" id="cat-12" name="categorias" value="Mascotas y veterinarias">
                  <label for="cat-12">Mascotas y veterinarias</label>
                </li>
                <li>
                  <input type="checkbox" id="cat-13" name="categorias" value="Productos artesanales o locales">
                  <label for="cat-13">Productos artesanales o locales</label>
                </li>
                <li>
                  <input type="checkbox" id="cat-otro" name="categorias" value="otro">
                  <label for="cat-otro">Otro</label>
                </li>
              </ul>
              <button type="button" id="categorias-listo" class="icon-button">Listo</button>
              <div id="otra-categoria">
                <input type="text" id="otra-categoria-input" name="otra_categoria" placeholder="Especificar categoría" data-translate="inicio.other_category_placeholder" />
              </div>
            </div>
          </div>
        </div>
        <button type="submit" data-translate="inicio.post_button">Publicar</button>
      </form>
    </div>
    <div id="feed" class="feed"></div>
  </div>

  <div id="confirm-modal" class="modal">
    <div class="modal-content">
      <p data-translate="inicio.delete_confirm">¿Estás seguro de que quieres eliminar esta publicación?</p>
      <button id="confirm-btn" data-translate="inicio.delete_button">Eliminar</button>
      <button id="cancel-btn" data-translate="inicio.cancel_button">Cancelar</button>
    </div>
  </div>

  <script src="translations.js"></script>
  <script>
    const starsContainer = document.querySelector('.stars');
    const numStars = 100;

    for (let i = 0; i < numStars; i++) {
      const star = document.createElement('div');
      star.classList.add('star');
      star.style.left = `${Math.random() * 100}vw`;
      star.style.top = '0';
      star.style.animationDelay = `${Math.random() * 5}s`;
      star.style.animationDuration = `${Math.random() * 10 + 10}s`;
      starsContainer.appendChild(star);
    }

    let savedTheme = localStorage.getItem('theme') || 'light';
    document.body.classList.toggle('dark-mode', savedTheme === 'dark');
    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.innerHTML = savedTheme === 'dark'
      ? '<i class="fas fa-sun"></i> ' + translations[localStorage.getItem('language') || 'es'].inicio.theme_toggle_light
      : '<i class="fas fa-moon"></i> ' + translations[localStorage.getItem('language') || 'es'].inicio.theme_toggle;

    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const lang = localStorage.getItem('language') || 'es';
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      themeToggle.innerHTML = isDark
        ? '<i class="fas fa-sun"></i> ' + translations[lang].inicio.theme_toggle_light
        : '<i class="fas fa-moon"></i> ' + translations[lang].inicio.theme_toggle;
      updateLanguage(lang);
    });

    let offset = 0;
    const limit = 10;
    let isLoading = false;
    let hasMore = true;
    let loadedPostIds = new Set();
    let currentUserId = null;
    let isSearching = false;

    async function fetchCurrentUserId() {
      try {
        const response = await fetch('/current_user');
        const data = await response.json();
        if (data.user_id !== null) {
          currentUserId = Number(data.user_id);
          const perfilLink = document.querySelector('#menu-perfil a[href="/perfil"]');
          perfilLink.href = data.tipo === 'explorador' ? '/perfil-especifico' : '/perfil';
        } else {
          const perfilLink = document.querySelector('#menu-perfil a[href="/perfil"]');
          perfilLink.href = '/login?target=/perfil';
        }
      } catch (error) {
        console.error('Error al obtener el usuario:', error);
        const perfilLink = document.querySelector('#menu-perfil a[href="/perfil"]');
        perfilLink.href = '/login?target=/perfil';
      }
    }

    function updateLanguage(lang) {
      document.querySelectorAll("[data-translate]").forEach(element => {
        const key = element.getAttribute("data-translate");
        const [page, textKey] = key.split('.');
        const translation = translations[lang][page][textKey];
        if (element.tagName === 'INPUT' && textKey.includes('placeholder')) {
          element.placeholder = translation;
        } else if (element.tagName === 'BUTTON' || element.tagName === 'A') {
          const span = element.querySelector('span');
          if (span) span.textContent = translation;
          else element.textContent = translation;
        } else {
          element.textContent = translation;
        }
      });
      const themeToggle = document.getElementById('theme-toggle');
      const isDark = document.body.classList.contains('dark-mode');
      themeToggle.innerHTML = isDark
        ? `<i class="fas fa-sun"></i> ${translations[lang].inicio.theme_toggle_light}`
        : `<i class="fas fa-moon"></i> ${translations[lang].inicio.theme_toggle}`;
      document.documentElement.lang = lang;
      updatePlaceholder();
    }

    function updatePlaceholder() {
      const contentInput = document.getElementById('content-input');
      const lang = localStorage.getItem('language') || 'es';
      contentInput.setAttribute('data-placeholder', translations[lang].inicio.post_placeholder);
    }

    const langSwitcher = document.getElementById('language-switcher');
    langSwitcher.addEventListener('change', (e) => {
      const selectedLang = e.target.value;
      localStorage.setItem('language', selectedLang);
      updateLanguage(selectedLang);
    });

    document.addEventListener('DOMContentLoaded', async () => {
      const savedLang = localStorage.getItem('language') || 'es';
      langSwitcher.value = savedLang;
      updateLanguage(savedLang);
      await fetchCurrentUserId();
      cargarFeed();
    });

    function showNotification(message, isError = false) {
      const notification = document.getElementById('notification');
      const messageElement = document.getElementById('notification-message');
      messageElement.textContent = message;
      notification.classList.remove('error');
      if (isError) {
        notification.classList.add('error');
        notification.querySelector('i').className = 'fas fa-exclamation-circle';
      } else {
        notification.querySelector('i').className = 'fas fa-check-circle';
      }
      notification.style.display = 'flex';
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in-out';
        setTimeout(() => {
          notification.style.display = 'none';
          notification.style.animation = 'slideIn 0.3s ease-in-out';
        }, 300);
      }, 3000);
    }

    function showConfirmModal(onConfirm) {
      const modal = document.getElementById('confirm-modal');
      modal.style.display = 'flex';
      const confirmBtn = document.getElementById('confirm-btn');
      const cancelBtn = document.getElementById('cancel-btn');
      confirmBtn.onclick = () => {
        onConfirm();
        modal.style.display = 'none';
      };
      cancelBtn.onclick = () => {
        modal.style.display = 'none';
      };
    }

    async function borrarPublicacion(postId, postElement) {
      showConfirmModal(async () => {
        try {
          const response = await fetch(`/borrar_publicacion/${postId}`, { method: 'DELETE' });
          if (response.ok) {
            postElement.style.transition = 'opacity 0.3s';
            postElement.style.opacity = '0';
            setTimeout(() => {
              postElement.remove();
              loadedPostIds.delete(postId);
            }, 300);
            showNotification(translations[localStorage.getItem('language') || 'es'].inicio.delete_success);
          } else {
            const data = await response.json();
            showNotification(`${translations[localStorage.getItem('language') || 'es'].inicio.delete_error}: ${data.detail || translations[localStorage.getItem('language') || 'es'].inicio.unknown_error}`, true);
          }
        } catch (error) {
          showNotification(translations[localStorage.getItem('language') || 'es'].inicio.delete_error_network, true);
        }
      });
    }

    async function cargarFeed() {
      if (isLoading || !hasMore || isSearching) return;
      isLoading = true;

      try {
        const res = await fetch(`/feed?limit=${limit}&offset=${offset}`);
        const publicaciones = await res.json();

        if (publicaciones.length < limit) {
          hasMore = false;
        }

        const feedDiv = document.getElementById('feed');
        publicaciones.forEach(pub => {
          if (loadedPostIds.has(pub.id)) return;
          loadedPostIds.add(pub.id);

          const div = document.createElement('div');
          div.classList.add('post');

          let postContent = `
            <div class="post-header">
              <img src="${pub.foto_perfil_url}" alt="Foto de perfil" class="post-profile-pic" onerror="this.src='/static/default_profile.png'">
              <div class="post-user-info">
                <span class="company-name">${pub.nombre_empresa}</span>
              </div>
            </div>
          `;

          if (currentUserId && pub.user_id && Number(pub.user_id) === Number(currentUserId)) {
            postContent += `
              <button class="delete-button" onclick="borrarPublicacion(${pub.id}, this.parentElement)" title="${translations[localStorage.getItem('language') || 'es'].inicio.delete_post_title}">
                <i class="fas fa-trash"></i>
              </button>
            `;
          }

          postContent += '<div class="post-content">';
          if (pub.contenido && pub.contenido.trim() !== '') {
            postContent += `<p>${pub.contenido}</p>`;
          }
          postContent += '</div>';

          postContent += '<div class="post-media">';
          if (pub.imagen_url && pub.imagen_url.trim() !== '') {
            postContent += `<img src="${pub.imagen_url}" alt="Imagen">`;
          }
          if (pub.video_url && pub.video_url.trim() !== '') {
            postContent += `<video controls src="${pub.video_url}"></video>`;
          }
          postContent += '</div>';

          postContent += '<div class="post-meta">';
          postContent += `
            <p>${translations[localStorage.getItem('language') || 'es'].inicio.tags_label}: ${pub.etiquetas && pub.etiquetas.length ? pub.etiquetas.join(', ') : translations[localStorage.getItem('language') || 'es'].inicio.no_tags}</p>
            <p>${pub.fecha_creacion}</p>
          `;
          postContent += '</div>';

          div.innerHTML = postContent;
          feedDiv.appendChild(div);
        });

        offset += limit;
      } catch (err) {
        showNotification(translations[localStorage.getItem('language') || 'es'].inicio.feed_error, true);
      } finally {
        isLoading = false;
      }
    }

    async function search() {
      const query = document.getElementById('buscador').value.trim();
      const feedDiv = document.getElementById('feed');
      loadedPostIds.clear();
      offset = 0;
      hasMore = true;

      if (!query) {
        isSearching = false;
        feedDiv.innerHTML = '';
        await cargarFeed();
        return;
      }

      isSearching = true;
      feedDiv.innerHTML = '';

      try {
        const response = await fetch(`/search?query=${encodeURIComponent(query)}&limit=${limit}&offset=${offset}`);
        const publicaciones = await response.json();

        if (publicaciones.length < limit) {
          hasMore = false;
        }

        publicaciones.forEach(pub => {
          if (loadedPostIds.has(pub.id)) return;
          loadedPostIds.add(pub.id);

          const div = document.createElement('div');
          div.classList.add('post');

          let postContent = `
            <div class="post-header">
              <img src="${pub.foto_perfil_url}" alt="Foto de perfil" class="post-profile-pic" onerror="this.src='/static/default_profile.png'">
              <div class="post-user-info">
                <span class="company-name">${pub.nombre_empresa}</span>
              </div>
            </div>
          `;

          if (currentUserId && pub.user_id && Number(pub.user_id) === Number(currentUserId)) {
            postContent += `
              <button class="delete-button" onclick="borrarPublicacion(${pub.id}, this.parentElement)" title="${translations[localStorage.getItem('language') || 'es'].inicio.delete_post_title}">
                <i class="fas fa-trash"></i>
              </button>
            `;
          }

          postContent += '<div class="post-content">';
          if (pub.contenido && pub.contenido.trim() !== '') {
            postContent += `<p>${pub.contenido}</p>`;
          }
          postContent += '</div>';

          postContent += '<div class="post-media">';
          if (pub.imagen_url && pub.imagen_url.trim() !== '') {
            postContent += `<img src="${pub.imagen_url}" alt="Imagen">`;
          }
          if (pub.video_url && pub.video_url.trim() !== '') {
            postContent += `<video controls src="${pub.video_url}"></video>`;
          }
          postContent += '</div>';

          postContent += '<div class="post-meta">';
          postContent += `
            <p>${translations[localStorage.getItem('language') || 'es'].inicio.tags_label}: ${pub.etiquetas && pub.etiquetas.length ? pub.etiquetas.join(', ') : translations[localStorage.getItem('language') || 'es'].inicio.no_tags}</p>
            <p>${pub.fecha_creacion}</p>
          `;
          postContent += '</div>';

          div.innerHTML = postContent;
          feedDiv.appendChild(div);
        });

        offset += limit;
      } catch (error) {
        showNotification(translations[localStorage.getItem('language') || 'es'].inicio.feed_error, true);
      }
    }

    const imagenInput = document.getElementById('imagen');
    const videoInput = document.getElementById('video');
    const contentInput = document.getElementById('content-input');
    const contenidoHidden = document.getElementById('contenido-hidden');
    const previewArea = document.getElementById('preview-area');
    const form = document.getElementById('form-publicar');
    const etiquetasPreview = document.getElementById('etiquetas-preview');

    function clearPreview() {
      previewArea.innerHTML = '';
      imagenInput.value = '';
      videoInput.value = '';
    }

    function addPreview(file, type) {
      if (!file) return;

      const wrapper = document.createElement('span');
      wrapper.classList.add('preview-wrapper');

      const previewElement = document.createElement('img');
      previewElement.classList.add(type === 'image' ? 'preview-image' : 'preview-video');

      const removeButton = document.createElement('button');
      removeButton.classList.add('remove-preview');
      removeButton.innerHTML = '×';
      removeButton.title = translations[localStorage.getItem('language') || 'es'].inicio.remove_preview_title;
      removeButton.addEventListener('click', () => {
        wrapper.remove();
        if (type === 'image') {
          imagenInput.value = '';
        } else {
          videoInput.value = '';
        }
        if (previewElement.src.startsWith('blob:')) {
          URL.revokeObjectURL(previewElement.src);
        }
      });

      if (type === 'image') {
        previewElement.src = URL.createObjectURL(file);
        wrapper.appendChild(previewElement);
        wrapper.appendChild(removeButton);
        previewArea.innerHTML = '';
        previewArea.appendChild(wrapper);
      } else {
        const video = document.createElement('video');
        video.src = URL.createObjectURL(file);
        video.addEventListener('loadeddata', () => {
          video.currentTime = 1;
        });
        video.addEventListener('seeked', () => {
          const canvas = document.createElement('canvas');
          canvas.width = 50;
          canvas.height = 50;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0, 50, 50);
          previewElement.src = canvas.toDataURL('image/png');
          wrapper.appendChild(previewElement);
          wrapper.appendChild(removeButton);
          previewArea.innerHTML = '';
          previewArea.appendChild(wrapper);
          URL.revokeObjectURL(video.src);
        }, { once: true });
      }
    }

    imagenInput.addEventListener('change', () => {
      if (imagenInput.files && imagenInput.files[0]) {
        addPreview(imagenInput.files[0], 'image');
      }
    });

    videoInput.addEventListener('change', () => {
      if (videoInput.files && videoInput.files[0]) {
        addPreview(videoInput.files[0], 'video');
      }
    });

    let isScrolling = false;
    window.addEventListener('scroll', () => {
      if (isScrolling) return;
      isScrolling = true;
      setTimeout(() => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100 && !isLoading && hasMore) {
          if (isSearching) {
            search();
          } else {
            cargarFeed();
          }
        }
        isScrolling = false;
      }, 100);
    });

    document.getElementById('perfil-btn').addEventListener('click', async function(event) {
      event.stopPropagation();
      const menu = document.getElementById('menu-perfil');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });

    document.getElementById('menu-perfil').addEventListener('click', function(event) {
      event.stopPropagation();
    });

    document.getElementById('categorias-toggle').addEventListener('click', function(event) {
      event.stopPropagation();
      const menu = document.getElementById('categorias-menu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });

    document.getElementById('categorias-menu').addEventListener('click', function(event) {
      event.stopPropagation();
    });

    document.addEventListener('click', function() {
      const perfilMenu = document.getElementById('menu-perfil');
      const categoriasMenu = document.getElementById('categorias-menu');
      if (perfilMenu.style.display === 'block') perfilMenu.style.display = 'none';
      if (categoriasMenu.style.display === 'block') categoriasMenu.style.display = 'none';
    });

    document.getElementById('cat-otro').addEventListener('change', function() {
      const otraCategoria = document.getElementById('otra-categoria');
      otraCategoria.style.display = this.checked ? 'block' : 'none';
    });

    // Manejo de etiquetas preview
    function updateEtiquetasPreview() {
      etiquetasPreview.innerHTML = '';
      const selectedCategorias = Array.from(document.querySelectorAll('input[name="categorias"]:checked')).map(input => input.value);
      let etiquetas = selectedCategorias.filter(cat => cat !== 'otro');
      if (selectedCategorias.includes('otro')) {
        const otraCategoria = document.getElementById('otra-categoria-input').value.trim();
        if (otraCategoria) etiquetas.push(otraCategoria);
      }

      etiquetas.forEach(tag => {
        const pill = document.createElement('span');
        pill.classList.add('etiqueta-pill');
        pill.textContent = tag;
        const removeBtn = document.createElement('button');
        removeBtn.classList.add('remove-etiqueta');
        removeBtn.innerHTML = '×';
        removeBtn.addEventListener('click', () => {
          const checkbox = document.querySelector(`input[name="categorias"][value="${tag}"]`);
          if (checkbox) {
            checkbox.checked = false;
          } else {
            document.getElementById('cat-otro').checked = false;
            document.getElementById('otra-categoria-input').value = '';
            document.getElementById('otra-categoria').style.display = 'none';
          }
          pill.remove();
        });
        pill.appendChild(removeBtn);
        etiquetasPreview.appendChild(pill);
      });
    }

    // Manejador para el botón "Listo"
    document.getElementById('categorias-listo').addEventListener('click', function(event) {
      event.stopPropagation();
      updateEtiquetasPreview();
      document.getElementById('categorias-menu').style.display = 'none';
      document.getElementById('otra-categoria').style.display = 'none';
    });

    // Actualizar preview al cambiar categorías
    document.querySelectorAll('input[name="categorias"]').forEach(checkbox => {
      checkbox.addEventListener('change', updateEtiquetasPreview);
    });
    document.getElementById('otra-categoria-input').addEventListener('input', updateEtiquetasPreview);

    form.addEventListener('submit', async function(event) {
      event.preventDefault();

      const formData = new FormData(form);
      const contenido = contentInput.innerText.trim();
      contenidoHidden.value = contenido;
      formData.set('contenido', contenido);

      const selectedCategorias = Array.from(document.querySelectorAll('input[name="categorias"]:checked')).map(input => input.value);
      let etiquetas = selectedCategorias.filter(cat => cat !== 'otro');
      if (selectedCategorias.includes('otro')) {
        const otraCategoria = document.getElementById('otra-categoria-input').value.trim();
        if (otraCategoria) etiquetas.push(otraCategoria);
      }
      const etiquetasString = etiquetas.join(',');
      formData.set('etiquetas', etiquetasString);

      const imagen = formData.get('imagen');
      const video = formData.get('video');

      if (!contenido && (!imagen || imagen.size === 0) && (!video || video.size === 0)) {
        showNotification(translations[localStorage.getItem('language') || 'es'].inicio.post_error_empty, true);
        return;
      }

      try {
        const response = await fetch('/publicar', {
          method: 'POST',
          body: formData,
        });

        if (response.ok) {
          showNotification(translations[localStorage.getItem('language') || 'es'].inicio.post_success);
          contentInput.innerText = '';
          contenidoHidden.value = '';
          clearPreview();
          etiquetasPreview.innerHTML = '';
          form.reset();
          document.getElementById('categorias-menu').style.display = 'none';
          document.getElementById('otra-categoria').style.display = 'none';
          offset = 0;
          hasMore = true;
          loadedPostIds.clear();
          document.getElementById('feed').innerHTML = '';
          await cargarFeed();
        } else {
          const data = await response.json();
          showNotification(`${translations[localStorage.getItem('language') || 'es'].inicio.post_error}: ${data.detail || translations[localStorage.getItem('language') || 'es'].inicio.unknown_error}`, true);
        }
      } catch (error) {
        showNotification(translations[localStorage.getItem('language') || 'es'].inicio.post_error_network, true);
      }
    });
  </script>
</body>
</html>